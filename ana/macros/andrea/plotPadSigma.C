#include <map>
#include <string>

#include <TString.h>
#include <TH1D.h>
#include <TH2D.h>
#include <TProfile.h>
#include <TStyle.h>
#include <TDirectory.h>
#include <TFile.h>
#include <TCanvas.h>
#include <TPaletteAxis.h>
#include <TPaveStats.h>

#include "SignalsType.hh"
#include "IntGetters.h"
#include "TPCconstants.hh"


ALPHAg::padmap pads;

void plotPadSigma()
{
  TFile* fin = (TFile*) gROOT->GetListOfFiles()->First();
  gDirectory->cd("padmatch");

  TString cname="ccogdiag";
  cname += GetRunNumber(TString(fin->GetName()));
  TCanvas* c0 = new TCanvas(cname,cname,1800,1900);
  c0->Divide(3,2);
  TH1D* hcognpeaks = (TH1D*) gROOT->FindObject("hcognpeaks");
  //hcognpeaks->GetXaxis()->CenterLabels();
  c0->cd(1);
  hcognpeaks->Draw();
  TH1D* hcogerr = (TH1D*) gROOT->FindObject("hcogerr");
  hcogerr->GetXaxis()->SetRangeUser(0.,5.);
  c0->cd(2);
  hcogerr->Draw();
  TH1D* hcogsigma = (TH1D*) gROOT->FindObject("hcogsigma");
  hcogsigma->GetXaxis()->SetRangeUser(0.,35.);
  c0->cd(3);
  hcogsigma->Draw();
  TH1D* htcog = (TH1D*) gROOT->FindObject("htimecog");
  c0->cd(4);
  htcog->Draw();
  gPad->SetLogy();
  TH1D* htblob = (TH1D*) gROOT->FindObject("htimeblobs");
  c0->cd(5);
  htblob->Draw();
  gPad->SetLogy();
  TH1D* htfit = (TH1D*) gROOT->FindObject("htimefit");
  c0->cd(6);
  htfit->Draw();
  gPad->SetLogy();
  c0->SaveAs(".pdf");

  TH2D* hps = (TH2D*) gROOT->FindObject("hcogpadssigma");
  hps->SetStats(kFALSE);
  // hps->RebinY(10);
  //  hps->GetYaxis()->SetRangeUser(0.,70.);
  cname = "PadSigmaR"; cname += GetRunNumber(TString(fin->GetName()));
  TCanvas* c1 = new TCanvas(cname,cname,1400,2500);
  //  c1->Divide(1,3);
  c1->Divide(1,2);
  c1->cd(1);
  //  hps->Draw("colz");

  int binymin = hps->GetYaxis()->FindBin(1.5);
  int binymax = hps->GetYaxis()->FindBin(10.);
  //  int binymax = -1;
  cout<<"Cut on sigma: "<<binymin<<" "<<binymax<<endl;
  TProfile* hpsx = hps->ProfileX("hprofpadsigma",binymin,binymax);
  hpsx->SetMarkerStyle(7);
  hpsx->SetLineColor(kBlack);
  // c1->cd(2);
  hpsx->Draw();
  hpsx->Fit("pol0","Q0");
  TF1* favgsig = hpsx->GetFunction("pol0");

  TH1D* hpsmax = new TH1D("hPadMaxSigma","Max Pad Sigma;pad index;#sigma [mm]",32*576,0.,32.*576.);
  TH2D* hPadSigma = new TH2D("hPadSigma","Induced Charge Sigma;row;sec;[mm]",
			     576,-0.5,575.5,32,-0.5,31.5);
  hPadSigma->SetStats(kFALSE);
  hPadSigma->SetMinimum(3.1);
  hPadSigma->SetMaximum(8.6);
  for(int bx=1; bx<=hps->GetNbinsX(); ++bx)
    {
      TString hname=TString::Format("%s_%d",hps->GetName(),bx);
      TH1D* h=hps->ProjectionY(hname, bx,bx);
      double max_sigma = h->GetBinCenter(h->GetMaximumBin());
      hpsmax->SetBinContent(bx,max_sigma);
      int row,sec;
      pads.get(bx-1,sec,row);
      if( row == 0 || row == 575 || 
	  (sec==23 && row==384) || 
	  (sec==21 && row==506) ||
	  (sec==12 && row==574) ||
	  (sec==24 && row==384) )// continue;
	max_sigma = favgsig->GetParameter(0);
      int bin = hPadSigma->GetBin(row+1,sec+1);
      hPadSigma->SetBinContent(bin,max_sigma);
    }
  //  c1->cd(3);
  c1->cd(2);
  hpsmax->Draw();
  c1->SaveAs(".pdf");

  cname = "RowColPadSigmaR"; cname += GetRunNumber(TString(fin->GetName()));
  TCanvas* c2 = new TCanvas(cname,cname,1600,1400);
  hPadSigma->Draw("colz");
  c2->Update();
  TPaletteAxis *pal2 = (TPaletteAxis*) hPadSigma->GetListOfFunctions()->FindObject("palette");
  pal2->SetX1NDC(0.91);
  pal2->SetX2NDC(0.92);
  c2->SaveAs(".pdf");


  TH2D* hpa = (TH2D*) gROOT->FindObject("hcogpadsamp");
  hpa->SetStats(kFALSE);
  cname = "PadAmpR"; cname += GetRunNumber(TString(fin->GetName()));
  //  TCanvas* c3 = new TCanvas(cname,cname,1400,2500);
  TCanvas* c3 = new TCanvas(cname,cname,1400,1500);
  //  c3->Divide(1,2);
  //  c3->cd(1);
  //  hpa->Draw("colz");

  binymin = hpa->GetYaxis()->FindBin(50);
  binymax = hpa->GetYaxis()->FindBin(5000.);
  cout<<"Cut on sigma: "<<binymin<<" "<<binymax<<endl;
  TProfile* hpax = hpa->ProfileX("hprofpadamp",binymin,binymax);
  hpax->SetMarkerStyle(7);
  hpax->SetLineColor(kBlack);
  hpax->SetMinimum(0.);
  //  c3->cd(2);
  c3->cd();
  hpax->Draw();
  gPad->Update();
  TPaveStats *stax = (TPaveStats*)hpax->FindObject("stats");
  stax->SetX1NDC(0.8);
  stax->SetX2NDC(0.99);
  stax->SetY1NDC(0.2);
  stax->SetY2NDC(0.5);
  c3->SaveAs(".pdf");

  TH2D* hPadQAmp = new TH2D("hPadQAmp","Induced Charge Amplitude;row;sec;[a.u.]",
  			     576,-0.5,575.5,32,-0.5,31.5);
  hPadQAmp->SetStats(kFALSE);
  //  hPadQAmp->SetMinimum(500);
  for(int b=1; b<=hpax->GetNbinsX(); ++b)
    {
      int row,sec;
      pads.get(b-1,sec,row);
      int bin = hPadQAmp->GetBin(row+1,sec+1);
      hPadQAmp->SetBinContent(bin,hpax->GetBinContent(b));
    }
  cname = "RowColPadQAmpR"; cname += GetRunNumber(TString(fin->GetName()));
  TCanvas* c4 = new TCanvas(cname,cname,1600,1400);
  hPadQAmp->Draw("colz");
  c4->Update();
  TPaletteAxis *pal4 = (TPaletteAxis*) hPadQAmp->GetListOfFunctions()->FindObject("palette");
  pal4->SetX1NDC(0.91);
  pal4->SetX2NDC(0.92);
  c4->SaveAs(".pdf");



  TH2D* hpi = (TH2D*) gROOT->FindObject("hcogpadsint");
  hpi->SetStats(kFALSE);
  cname = "PadIntR"; cname += GetRunNumber(TString(fin->GetName()));
  // TCanvas* c5 = new TCanvas(cname,cname,1400,2500);
  TCanvas* c5 = new TCanvas(cname,cname,1400,1500);
  // c5->Divide(1,2);
  // c5->cd(1);
  // hpa->Draw("colz");

  binymin = hpi->GetYaxis()->FindBin(18);
  //  binymax = hpi->GetYaxis()->FindBin(5000.);
  binymax = -1;
  cout<<"Cut on sigma: "<<binymin<<" "<<binymax<<endl;
  TProfile* hpix = hpi->ProfileX("hprofpadint",binymin,binymax);
  hpix->SetMarkerStyle(7);
  hpix->SetLineColor(kBlack);
  // c5->cd(2);
  c5->cd();
  hpix->Draw();
  gPad->Update();
  TPaveStats *stix = (TPaveStats*)hpix->FindObject("stats");
  stix->SetX1NDC(0.8);
  stix->SetX2NDC(0.99);
  stix->SetY1NDC(0.2);
  stix->SetY2NDC(0.5);
  c5->SaveAs(".pdf");

  TH2D* hPadQInt = new TH2D("hPadQInt","Induced Charge Integral;row;sec;[a.u.]",
			    576,-0.5,575.5,32,-0.5,31.5);
  hPadQInt->SetStats(kFALSE);
  hPadQInt->SetMinimum(2000.);
  for(int b=1; b<=hpix->GetNbinsX(); ++b)
    {
      int row,sec;
      pads.get(b-1,sec,row);
      int bin = hPadQInt->GetBin(row+1,sec+1);
      hPadQInt->SetBinContent(bin,hpix->GetBinContent(b));
    }
  cname = "RowColPadQIntR"; cname += GetRunNumber(TString(fin->GetName()));
  TCanvas* c6 = new TCanvas(cname,cname,1600,1400);
  hPadQInt->Draw("colz");
  c6->Update();
  TPaletteAxis *pal6 = (TPaletteAxis*) hPadQInt->GetListOfFunctions()->FindObject("palette");
  pal6->SetX1NDC(0.91);
  pal6->SetX2NDC(0.92);
  c6->SaveAs(".pdf");

  double xmax = 40.; // mm
  cout<<"Z err < "<<xmax<<endl;
  gDirectory->cd("/paddeconv");
  TH1D* hErrPad = (TH1D*) gROOT->FindObject("hErrPad");
  cname = "cErrPad"; cname += GetRunNumber(TString(fin->GetName()));
  TCanvas* c7 = new TCanvas(cname,cname,1200,1000);
  hErrPad->Draw();
  hErrPad->GetXaxis()->SetTitle("Z err [mm]");
  hErrPad->GetXaxis()->SetRangeUser(0.,xmax);
  c7->SaveAs(".pdf");
}
