<!DOCTYPE html>
<html class="mcss">
<head>
   <meta charset="UTF-8">
   <link rel="stylesheet" href="midas.css">
   <script src="midas.js"></script>
   <script src="mhttpd.js"></script>
   <title>TRG</title> <!-- Change XXX to page title -->
</head>

<body class="mcss" onload="mhttpd_init('TRG')"> <!-- Change XXX to the menu item for this page -->

<!-- header and side navigation will be filled automatically in mhttpd_start -->
<div id="mheader"></div>
<div id="msidenav"></div>

<div id="mmain">
<div id="obscure_div">
  <table class="mtable">
    <tr>
      <th class="mtableheader">TRG</th> <!-- Change XXX to the header name for this page -->
    </tr>
    <tr>
      <div>
	<table class="mtable" align=center>
	  <tr align=center>
	    <td class="mtableheader" colspan=2>Common settings</td>
	  </tr>
	  <tr align=center>
	    <td>62.5MHz PLL status</td>
	    <td id=pll_625_status>pll_625_status</td>
	  </tr>
	  <tr align=center>
	    <td>External eSATA clock frequency</td>
	    <td id=clk_625_freq>clk_625_freq</td>
	  </tr>
	  <tr align=center>
	    <td>-</td>
	    <td>-</td>
	  </tr>
	  <tr align=center>
	    <td>eSATA mask</td>
	    <td id=esata_mask>esata_mask</td>
	  </tr>
	  <tr align=center>
	    <td>NIM mask</td>
	    <td id=nim_mask>nim_mask</td>
	  </tr>
	  <tr align=center>
	    <td>-</td>
	    <td>-</td>
	  </tr>
	  <tr align=center>
	    <td>Counter eSATA+NIM</td>
	    <td><tt id=counter_esata_nim_grand_or>counter</tt> - <tt id=rate_esata_nim_grand_or>rate</tt> Hz</td>
	  </tr>
	  <tr align=center>
	    <td>Counter pulser</td>
	    <td><tt id=counter_pulser>counter</tt> - <tt id=rate_pulser>rate</tt> Hz</td>
	  </tr>
	  <tr align=center>
	    <td>Counter adc16</td>
	    <td><tt id=counter_adc16_grand_or>counter</tt> - <tt id=rate_adc16_grand_or>rate</tt> Hz</td>
	  </tr>
	  <tr align=center>
	    <td>Counter adc32</td>
	    <td><tt id=counter_adc32_grand_or>counter</tt> - <tt id=rate_adc32_grand_or>rate</tt> Hz</td>
	  </tr>
	  <tr align=center>
	    <td>Counter aw coinc</td>
	    <td><tt id=counter_aw_coinc>counter</tt> - <tt id=rate_aw_coinc>rate</tt> Hz</td>
	  </tr>
	  <tr align=center>
	    <td>Counter aw mlu</td>
	    <td><tt id=counter_aw_mlu>counter</tt> - <tt id=rate_aw_mlu>rate</tt> Hz</td>
	  </tr>
	  <tr align=center>
	    <td>-</td>
	    <td>-</td>
	  </tr>
	  <tr align=center>
	    <td>Counter received</td>
	    <td><tt id=counter_received>counter</tt> - <tt id=rate_received>rate</tt> Hz</td>
	  </tr>
	  <tr align=center>
	    <td>Counter drift blank-off</td>
	    <td><tt id=counter_drift>counter</tt> - <tt id=rate_drift>rate</tt> Hz</td>
	  </tr>
	  <tr align=center>
	    <td>Counter scaledown</td>
	    <td><tt id=counter_scaledown>counter</tt> - <tt id=rate_scaledown>rate</tt> Hz</td>
	  </tr>
	  <tr align=center>
	    <td>Counter accepted</td>
	    <td><tt id=counter_accepted>counter</tt> - <tt id=rate_accepted>rate</tt> Hz</td>
	  </tr>
	  <tr align=center>
	    <td>Dead time</td>
	    <td id=deadtime>deadtime</td>
	  </tr>
	  <tr align=center>
	    <td>-</td>
	    <td>-</td>
	  </tr>
	  <tr align=center>
	    <td>ODB settings</td>
	    <td><a href="https://alphagdaq.cern.ch/Equipment/CTRL/Settings">Settings</a></td>
	  </tr>
	  <tr align=center>
	    <td>Action</td>
	    <td>
	      <!---<button onclick="//update_settings()">Update settings</button>--->
	      <button onclick="init_trg()">Initialize</button>
	      <button onclick="load_mlu_trg()">XLoadMLU</button>
	      <button onclick="start_trg()">XStart</button>
	      <button onclick="stop_trg()">XStop</button>
	      <button onclick="read_trg()">Read</button>
	    </td>
	  </tr>
	</table>
      </div>
    </tr>
    <tr>
      <td>
	<div align=center>
	  <table class="mtable" id="datatable" align=center>
	    <th class="mtableheader" colspan=10>Data links</th>
	    <tr align=center>
	      <td>Link</td>
	      <td>SD</td>
	      <td>Counter</td>
	      <td>ADC</td>
	      <td>Data</td>
	      <td>Mask16</td>
	      <td>Rate16</td>
	      <td>Mask32</td>
	      <td>Rate32 15..0</td>
	      <td>Rate32 31..16</td>
	    </tr>
	    <tr id="datatable_last" align=center>
	    </tr>
	  </table>
	</div>
    </tr>
    <tr>
      <div id="updateStatus" align="left">
        updateStatus
      </div>
    </tr>
    
    <script>
      var update_timer_id;

      function jrpc(cmd, args)
      {
      document.getElementById("obscure_div").style.backgroundColor = "black";
      mjsonrpc_call("jrpc", { "client_name":"fectrl", "cmd":cmd, "args":args }).then(function(rpc){console.log("jrpc reply: " + JSON.stringify(rpc.result)); update(); }).catch(function(error){mjsonrpc_error_alert(error);});
      }

      function init_trg(name)
      {
      console.log("init_trg");
      jrpc("init_trg", "");
      }

      function load_mlu_trg(name)
      {
      console.log("load_mlu_trg");
      jrpc("load_mlu_trg", "");
      }

      function start_trg(name)
      {
      console.log("start_trg");
      jrpc("start_trg", "");
      }

      function stop_trg(name)
      {
      console.log("stop_trg");
      jrpc("stop_trg", "");
      }

      function read_trg()
      {
      console.log("read_trg!");
      jrpc("read_trg", "");
      }

    function set_text(id, text)
    {
       var e = document.getElementById(id);
       if (e)
          e.innerHTML = text;
    }

    function set_text_yn(id, yn)
    {
       var e = document.getElementById(id);
       if (e) {
          if (yn) {
             e.innerHTML = "y";
          } else {
             e.innerHTML = "-";
          }
       }
    }

    function set_colour(id, colour)
    {
       var e = document.getElementById(id);
       if (e) {
          e.style["background-color"] = colour;
       }
    }

    function toHex32(v)
    {
      v += 0x100000000;
      return "0x" + v.toString(16).substr(-8);
    }

    function toHex16(v)
    {
      return "0x" + v.toString(16);
    }

    function create_row(i)
    {
       var id = "row" + i;
       var tr = document.createElement("tr");
       tr.id = id;
       var td = document.createElement("td"); td.id = "link"+i; td.align="center"; tr.appendChild(td);
       var td = document.createElement("td"); td.id = "sd"+i; td.align="center"; tr.appendChild(td);
       var td = document.createElement("td"); td.id = "sd_counter"+i; td.align="center"; tr.appendChild(td);
       var td = document.createElement("td"); td.id = "adc"+i; td.align="center"; tr.appendChild(td);
       var td = document.createElement("td"); td.id = "data"+i; td.align="center"; tr.appendChild(td);
       var td = document.createElement("td"); td.id = "mask16"+i; td.align="center"; tr.appendChild(td);
       var td = document.createElement("td"); td.id = "rate16"+i; td.align="right"; tr.appendChild(td);
       var td = document.createElement("td"); td.id = "mask32"+i; td.align="center"; tr.appendChild(td);
       var td = document.createElement("td"); td.id = "rate32a"+i; td.align="right"; tr.appendChild(td);
       var td = document.createElement("td"); td.id = "rate32b"+i; td.align="right"; tr.appendChild(td);

       var last = document.getElementById("datatable_last");
       //document.getElementById("datatable").insertBefore(tr, last);
       last.insertAdjacentElement("beforebegin", tr);
    }

    function callback(rpc)
    {
       //console.log("callback!");
       document.getElementById("obscure_div").style.backgroundColor = "";
       //document.getElementById('updateStatus').innerHTML = "RWP_";
       
       //alert("Hello: " + JSON.stringify(rpc));
       //console.log("rpc: " + JSON.stringify(rpc));
       
       var s = rpc.result.data[0];
       var v = rpc.result.data[1];
       var st = rpc.result.data[2];

       //set_text_yn("enable", s.enable);
       //set_text_yn("trigger", s.trigger);

       set_text("pll_625_status", toHex32(v.trg_pll_625_status) + " (" + st.trg_pll_status_string + ")");
       set_colour("pll_625_status", st.trg_pll_status_colour);
       set_text("clk_625_freq", v.trg_clk_625_freq.toFixed(1));

       set_text("esata_mask", s.trig.esatamask);
       set_text("nim_mask", s.trig.nimmask);

       set_text("counter_esata_nim_grand_or", v.scalers[7]);
       set_text("rate_esata_nim_grand_or", v.scalers_rate[7].toFixed(2));
       
       set_text("counter_pulser", v.scalers[3]);
       set_text("rate_pulser", v.scalers_rate[3].toFixed(2));
       
       set_text("counter_adc16_grand_or", v.scalers[4]);
       set_text("rate_adc16_grand_or", v.scalers_rate[4].toFixed(2));
       
       set_text("counter_adc32_grand_or", v.scalers[5]);
       set_text("rate_adc32_grand_or", v.scalers_rate[5].toFixed(2));
       
       set_text("counter_aw_coinc", v.scalers[66]);
       set_text("rate_aw_coinc", v.scalers_rate[66].toFixed(2));
       
       set_text("counter_aw_mlu", v.scalers[67]);
       set_text("rate_aw_mlu", v.scalers_rate[67].toFixed(2));
       
       set_text("counter_received", v.scalers[2]);
       set_text("rate_received", v.scalers_rate[2].toFixed(2));
       
       set_text("counter_drift", v.scalers[64]);
       set_text("rate_drift", v.scalers_rate[64].toFixed(2));

       set_text("counter_scaledown", v.scalers[65]);
       set_text("rate_scaledown", v.scalers_rate[65].toFixed(2));

       set_text("counter_accepted", v.scalers[1]);
       set_text("rate_accepted", v.scalers_rate[1].toFixed(2));

       set_text("deadtime", v.trigger_dead_time.toFixed(2) + "%");
       
       for (var i=0; i<16; i++) {
          set_text("link"+i, i);
          var sdi = v.sas_sd & (1<<i);
          set_text_yn("sd"+i, sdi);
          if (!sdi) {
             set_colour("sd"+i, "red");
          } else {
             set_colour("sd"+i, "");
          }
          set_text("sd_counter"+i, v.sas_sd_counters[i]);
          set_text("adc"+i, s.adc.modules[i]);
          set_text("data"+i, toHex32(v.sas_bits[2*i+1]) + " " + toHex32(v.sas_bits[2*i+0]));
          set_text("mask16"+i, toHex16(s.trig.adc16_masks[i]));
          set_text("rate16"+i, v.scalers_rate[16+i].toFixed(1));
          set_text("mask32"+i, toHex32(s.trig.adc32_masks[i]));
          set_text("rate32a"+i, v.scalers_rate[32+i*2+0].toFixed(1));
          set_text("rate32b"+i, v.scalers_rate[32+i*2+1].toFixed(1));
          //set_colour("user_page"+i, "#FFFFFF");
       }
       
       //document.getElementById('mhttpd_last_updated').innerHTML = new Date;
       //document.getElementById('updateStatus').innerHTML = "RWPD";
       document.getElementById('updateStatus').innerHTML = "";
    }

    function update()
    {
       //console.log("update!");
       var paths = [ "/Equipment/CTRL/Settings", "/Equipment/CTRL/Variables", "/Equipment/CTRL/Status" ];
       //document.getElementById('updateStatus').innerHTML = "R___";
       mjsonrpc_db_get_values(paths).then(function(rpc) {
          callback(rpc);
       }).catch(function(error) {
          document.getElementById('updateStatus').innerHTML = "RWE: RPC or JS error: " + mjsonrpc_decode_error(error);
       });
       //document.getElementById('updateStatus').innerHTML = "RW__";
    }
    

    function update_periodic()
    {
       clearTimeout(update_timer_id);
       var update_period = 1000;
       update();
       update_timer_id = setTimeout('update_periodic()', update_period);
    }

    for (var i=0; i<16; i++) {
       create_row(i);
    }
    
    update_periodic();
    </script>
  </table>
</div>
</div>
</body>
</html>
